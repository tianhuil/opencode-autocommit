# OpenCode Auto-Commit Plugin

A plugin for OpenCode that automatically commits changes when a turn completes.

## Features

- **Auto-commit on turn completion**: Automatically commits changes when a session turn completes (`session.idle` event)
- **Worktree support**: Can be configured to work only on worktrees or both worktrees and main worktree
- **Custom commit messages**: Generates meaningful commit messages using AI
- **Configurable settings**: Manage plugin behavior with tools

## Installation

The plugin is automatically loaded from `.opencode/plugins/` directory. No additional installation needed.

## Configuration

### Settings File

Create `.opencode/auto-commit.settings.yml` to configure default settings:

```yaml
mode: disabled  # disabled | worktree | enabled
commitModel: anthropic/claude-3-5-sonnet-20241022  # optional, uses current model if not set
maxCommitLength: 10000  # maximum commit message length in characters
```

### Settings

- **mode** (default: `disabled`):
  - `disabled`: Plugin is completely disabled
  - `worktree`: Plugin is enabled only on worktrees, not on main worktree
  - `enabled`: Plugin is enabled on both worktrees and main worktree

- **commitModel** (optional):
  - Model name to use for generating commit messages
  - If not set, uses the current session's model
  - Example: `anthropic/claude-3-5-sonnet-20241022`

- **maxCommitLength** (default: `10000`):
  - Maximum length of the full commit message in characters
  - If exceeded, the LLM Response section is truncated with `...` suffix
  - Minimum value: `100`

### Commit Message Format

The plugin generates commit messages in the following format:

```
{summary}

## User Prompt
{user_prompt}

## LLM Response
{llm_response}
```

- **Summary**: One-line summary (max 50 chars) generated by AI
- **User Prompt**: Verbatim user prompt that started the turn
- **LLM Response**: Full AI response (truncated if exceeds `maxCommitLength`)

## Usage

### Managing Settings

The plugin provides three tools to manage settings:

#### Get Current Settings
```bash
/getAutoCommitSettings
```

#### Update Settings
```bash
/setAutoCommitSettings mode=enabled maxCommitLength=5000
```

#### Reset to Defaults
```bash
/resetAutoCommitSettings
```

### Example Slash Command

Create `.opencode/command/autocommit.md`:

```markdown
---
description: Manage auto-commit plugin settings
---

Use the auto-commit plugin tools:
- /getAutoCommitSettings to view current settings
- /setAutoCommitSettings to update settings
- /resetAutoCommitSettings to reset to defaults

Available settings:
- mode: disabled, worktree, or enabled
- commitModel: model name for generating commit messages
- maxCommitLength: maximum commit message length (min 100, default 10000)
```

Then use in TUI:
```bash
/autocommit
```

## How It Works

1. When `session.idle` event fires (AI finishes responding)
2. Plugin checks if auto-commit is enabled for current worktree
3. Fetches all messages from the session
4. Identifies the last turn (user message + AI responses)
5. Checks for uncommitted git changes
6. Generates a commit summary using AI (if configured)
7. Creates a commit with the full message format
8. Logs success or errors

## Error Handling

The plugin handles errors gracefully:
- Git command failures are logged via `client.app.log()` with error level
- Does not interrupt user workflow
- Continues to work on subsequent turns

## License

MIT
