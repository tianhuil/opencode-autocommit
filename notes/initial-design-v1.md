# opencode-autocommit design doc
I am building an opencode plugin called opencode-autocommit.  When enabled:

## Understanding "Turns" in Opencode

In opencode, a **turn** is a complete interaction cycle consisting of:
1. User prompt (start of turn)
2. AI processing and responding
3. Turn completes when the AI finishes and the `session.idle` event fires

## General functionality
Every time a turn completes (`session.idle` event fires), the plugin intercepts the signal and commits all changes on the branch.

### worktrees
This needs to work with worktrees.  If the user is on a worktree, all changes apply to the worktree, not the main worktree.


### Commit message!
The commit message takes the following format.  It is 3 sections separated by two newlines

```md
{summary}

## User Prompt
{user_prompt}

## LLM Response
{llm_responses}
```

The `summary` is a one line summary (no longer than 50 chars) of this turn (user prompt + AI response).  It is generated by `commitModel`.

The `user_prompt` is the verbatim user prompt that started the turn

The `llm_responses` is the full response of the LLM during this turn

The message maybe truncated per `maxCommitLength`.

## Settings
Here are the settings.  The type will be defined and validated by zod.

### `mode`:
- `'disabled'`: plugin is disabled
- `'worktree'`: plugin is enabled only on worktrees but not on the main worktree; this is the default value
- `'enabled'`: plugin is enabled only on worktrees and the main worktree

### `commitModel`
This is the name of the model for opencode to use to generate a commit message.  If it is `undefined`, we should use whatever the current model is.

### `maxCommitLength`
Maximum length of the full commit message in characters.  If the generated commit message exceeds this length, the LLM Response section will be truncated from the end.  Default is 10000 characters.

### Truncation Strategy
If the total commit message exceeds `maxCommitLength`, the truncation is applied to the entire message.  Truncated sections should include a `...` suffix to indicate where it was cut off.

### Zod Schema
```ts
const ZAutoCommitMode = z.enum(['disabled', 'worktree', 'enabled']);

const ZAutoCommitSettings = z.object({
  mode: AutoCommitMode.default('worktree'),
  commitModel: z.string().optional(), // If not set, use opencode's default model
  maxCommitLength: z.number().min(100).default(10000), // Maximum commit message length in characters
});

// Derived TypeScript types
type ZAutoCommitMode = z.infer<typeof ZAutoCommitMode>;
type ZAutoCommitSettings = z.infer<typeof ZAutoCommitSettings>;
```

## Settings File
If there is a `.opencode/auto-commit.settings.yml` file, which contains the yml representation of the settings schema.  It will be read for validation and the values are used as initial settings and override the earlier given defaults.  The values can be changed with slash commands and tools below.

## Slash commands
There is a slash command `/autocommit` which can be used to fetch the mode or set it.  It calls the tools listed below

## Tools
There is a tool
- `getSettings() ZAutoCommitSettings: ` 
- `setSettings(param: Partial<ZAutoCommitSettings>): ZAutoCommitSettings`.
- `resetSettings(): ZAutoCommitSettings` (resets to defaults from `.opencode/auto-commit.settings.yml` if it exists or general defaults if not.)

Both `setSettings` and `resetSettings` return the new settings.

## Additional References

In @notes/opencode-plugin-session-idle.md, use the "Complete Example: Auto-Commit Plugin" as an implementation guide.
